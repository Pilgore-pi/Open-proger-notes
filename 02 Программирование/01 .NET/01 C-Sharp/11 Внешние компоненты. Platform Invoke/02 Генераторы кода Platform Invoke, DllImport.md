
https://learn.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke-source-generation

С до выхода .NET 7 для обращения к нативным сборкам использовался атрибут `DllImport`. При этом приходилось явно определять необходимые типы-обертки над неуправляемыми типами из нативных библиотек.

## Механизм P/Invoke без генераторов кода

Встроенная система взаимодействия среды выполнения .NET создает поток-заглушку (stream) в IL коде, который преобразуется в JIT байт код во время выполнения, чтобы упростить переход от управляемого к неуправляемому коду.

Следующий пример демонстрирует определение и вызов P/Invoke, использующий этот механизм:

```cs
[DllImport(
    "nativelib",
    EntryPoint = "to_lower",
    CharSet = CharSet.Unicode)]
internal static extern string ToLower(string str);

// string lower = ToLower("StringToConvert");
```

Заглушка IL выполняет маршаллинг параметров функции и возвращаемых значений, и вызывает неуправляемый код применяя настройки, указанные атрибутом `DllImportAttribute`. Эти настройки влияют но то, как неуправляемый код должен вызываться (к примеру, запись кода ошибки в поток (thread) через функцию `SetLastError()`).

Так как эта заглушка генерируется во время выполнения, применение технологии **ahead-of-time (AOT)** невозможно, как и невозможна обрезка кода IL. Генерация IL при маршаллинге имеет свою цену. Могут возникать проблемы в разрезах производительности приложения и поддержики потенциальных платформ, которые могут не поддерживать динамическую генерацию кода. В нативных AOT приложениях проблемы решаются благодаря предварительной компиляции всего кода непосредственно в нативный код.

Использование `DllImport` привносит свои трудности в процесс отладки и разработки.

- **Усложнение кода**. Для использования нативных библиотек приходиться писать много трудночитаемого кода
- **Сложная отладка**. Из усложнения кода, также, вытекает усложнение процесса отладки. К тому же, отладка осложнена взаимодействием с неуправляемыми структурами данных
- **Сложность поддержки**. Неуправляемый код требует более жесткого контроля и, в целом, неуправляемый код имеет более низкий уровень абстракции, что может усложнить восприятие исходного кода программы

По этим и другим причинам, начиная с версии .NET 7 был добавлен новый генератор кода для P/Invoke, который распознает атрибут `LibraryImportAttribute` в C\# коде и генерирует весь необходимый код с атрибутами `DllImport`, `extern`-методами и спец. структурами, отображающие неуправляемые типы.

## Генераторы кода и атрибут LibraryImport

Работа с атрибутом `LibraryImport` орагнизована аналогично механизму через `DllImport`. Пример, приведенный выше, можено преобразовать в следующий код без особых изменений:

```cs
[LibraryImport(
    "nativelib",
    EntryPoint = "to_lower",
    StringMarshalling = StringMarshalling.Utf16)]
internal static partial string ToLower(string str);
```

В процессе компиляции, генератор кода создаст метод `ToLower()` и весь поддерживающий его код. Все маршаллинги и создание управляемых типов оберток будут выполненены автоматически.

#C-Sharp #C-Sharp/P-Invoke #API
