
# ПЕРЕНЕСТИ В 03 Базы данных / Entity Framework

Здесь будет пошаговое руководство по наладке базы данных с использованием фреймворка EF Core

Общий алгоритм дальейшей практической работы можно описать следующими шагами:

1. Установка пакетов Nuget для EF Core
2. Создание моделей SQL таблиц в коде C#
3. Создание и запуск миграции, на основе описанных моделей данных


## 1. Начальные условия

Допустим, что мы уже имеем готовое приложение с пользовательским интерфейсом, которое взаимодействует с простенькой базой данных, представленной в виде одного файла Excel, где определены 2 таблицы (по одной на каждой странице). Данные считываются и записываются непосредственно в файл Excel, который может открыть любой пользователь ОС, что нарушает ограничения доступа к данным

**User (Пользователь приложения):**

- `string Name`: Имя пользователя приложения
- `string PasswordHash`: Хэш-значение пароля пользователя
- `enum Role`: Роль пользователя, разграничивающая его права в приложении. `enum Role { ReadOnly, Admin }`, роль `ReadOnly` позволяет пользователю только читать данные, роль `Admin` позволяет выполнять **CRUD** (Create, Read, Update, Delete) операции
- `DateTime Changed`: Временная метка, показывающее дату и время последнего изменения данных пользователя

**Employee (Информация о сотруднике):**

Это основная таблица БД, с которой взаимодействует пользователь

- `string PhoneNumber`: Номер телефона
- `string FullName`: Полное имя
- `string Division`: Подразделение организации, к которому относится сотрудник
- `string Post`: Должность работника
- `string Building`: Корпус (где работает сотрудник)
- `int Floor`: Этаж
- `DateTime Changed`: Временная метка, показывающее дату и время последнего изменения

### Структура проекта

В гепотетическом проекте нашего приложения есть 3 каталога:

- `Models`: Модели приложения, классы-обертки над сущностями `User` и `Employee`:
    - `User.cs`
    - `Employee.cs`
- `Services`: Сервисные API для упрощенного доступа к файлу Excel
    - `DataApi.cs`: Логика взаимодействия с Excel
- `Views`
    - `AuthView.xaml`: Форма авторизации и регистрации пользователя
    - `WorkView.xaml`: Основная форма работы с данными о сотрудниках организации

### Пример заполненного файла Excel

Первая страница (Employee):

| Подразделение | ФИО | Должность | Номер телефона | Корпус | Этаж |
|:-|:-|:-|:-|:-|:-|
| Отдел управления | Иванов Сергей Владимирович | начальник управления по безопасности | 6004 | 55 | 1 |
| Отдел управления | Смирнова Анна Петровна | ЗГД по кадрам и соц. вопросам | 6006 | 96 | 1 |
| Отдел управления | Кузнецов Алексей Иванович | ЗГД - управляющий делами | 6017 | 128 | 2 |
| Отдел управления | Попова Марина Александровна | главный инженер | 6020 | 128 | 2 |
| Отдел управления | Волков Дмитрий Сергеевич | зам. главного инженера | +79008002030 | 128 | 2 |
| Отдел информационной безопасности | Лебедева Светлана Викторовна | Главный специалист по безопасности | 6301 | 128 | 1 |
| Отдел строительства | Новиков Михаил Андреевич | зам. начальника управления по стр-ву | 6302 |  |  |
|  | Морозова Елена Николаевна | аудитор | 6303 | 128 | 3 |
| Отдел управления | Федоров Олег Юрьевич | первый зам. директора | 6306 | 128 | 4 |
| Отдел безопасности труда | Васильева Наталья Борисовна | ЗГД по безопасности труда | 6307 | 128 | 4 |
| Отдел информационной безопасности | Соколов Павел Дмитриевич | Специалист по инф. безопасности | 6304 | 128 | 4 |
| Отдел информационной безопасности | Павлова Ирина Владимировна |  | 6308 |  |  |
| 13 цех | Михайлов Виктор Сергеевич | начальник участка | 6007 | 19 | 4 |
| 13 цех | Григорьева Татьяна Ивановна | начальник тех. бюро | 60071 | 19 | 4 |


## 2. Цель

Целью работы является перенести существующие данные в SQL базу данных и обеспечить программное взаимодействие с этой базой. Так как пользователи могут продолжать предоставлять данные в Excel формате, нужно написать конвертер Excel файлов в записи SQL базы данных

## 3. Подготовка проекта

Для использования EF Core потребуется установить несколько пакетов Nuget:

- **`Microsoft.EntityFrameworkCore`:** Основной пакет для EF Core с базовой функциональностью
- **`Microsoft.EntityFrameworkCore.Sqlite`:** Провайдер базы данных, мы будем использовать SQL Lite, так как это легковесная СУБД, подходящая для нашего маленького приложения. Можно использовать других провайдеров: `Microsoft.EntityFrameworkCore.SqlServer`, `Npgsql.EntityFrameworkCore.PostgreSQL` (от стороннего поставщика)
- **`Microsoft.EntityFrameworkCore.Tools`:** Для поддержки миграций и командной строки в разработке (опционально)

Установить пакеты можно через:

- Менеджер пакетов Nuget в используемой IDE (самый простой вариант)
- Консоль диспетчера пакетов:

```powershell
Install-Package Microsoft.EntityFrameworkCore
Install-Package Microsoft.EntityFrameworkCore.SqlServer
Install-Package Microsoft.EntityFrameworkCore.Tools
```

- .NET CLI:

```bash
dotnet add package Microsoft.EntityFrameworkCore
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
dotnet add package Microsoft.EntityFrameworkCore.Tools
```

## 4. Создание структуры базы данных

Для создания структуры БД нужно выполнить следующие шаги:

1. Создать модели SQL таблиц в коде C#
2. Создать контекст БД (`DbContext`)
3. Создать и выполнить миграцию

Существующие модели `User.cs` и `Employee.cs` могут не подходить для создания миграции, поэтому изменим эти классы или создадим свои аналоги в виде POCO-классов

```cs
public enum Role {
    ReadOnly,
    Admin
}

public class User {
    public int Id { get; set; }  // ORM воспринимает свойство, оканчивающееся на "Id" как первичный ключ

    [Required, MinLength(3), MaxLength(50)]
    public string Name { get; set; }

    [Required, MinLength(6)]
    public string PasswordHash { get; set; }

    [Required]
    public Role Role { get; set; }

    public DateTime Changed { get; set; }
}

public class Employee {
    public int Id { get; set; }  // Первичный ключ

    // Номер телефона: 11 цифр с или без специальных символов ИЛИ простая последовательность цифр длиной от 4 до 11
    [Required, RegularExpression(@"^((\+7|8)\s?(?:\((\d{3})\)|(\d{3}))\s?\d{3}[-\s]?\d{2}[-\s]?\d{2}$|^(\+7|8)\s?(?:\((\d{3})\)|(\d{3}))\s?\d{3}[-\s]?\d{4})|((\s*\d\s*){4,11})$")]
    public string PhoneNumber { get; set; }

    public string? FullName { get; set; }

    public string? Division { get; set; }

    public string? Post { get; set; }

    public string? Building { get; set; }

    public int? Floor { get; set; }

    public DateTime Changed { get; set; }
}
```

* Регулярные выражения не поддерживаются провайдером БД SQL Lite. Атрибут `[RegularExpression]` создает ограничение только на уровне приложения

#MERGE_NOTES
