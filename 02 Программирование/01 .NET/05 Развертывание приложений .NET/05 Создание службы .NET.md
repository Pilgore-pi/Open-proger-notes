
Алгоритм создания службы:

- Создание проекта по шаблону
- Выпуск проекта
- Регистрация исполняемого файла как службы
- Запуск службы

----

https://learn.microsoft.com/ru-ru/dotnet/core/extensions/windows-service
https://habr.com/ru/articles/863770/


Существует 2 API для разработки служб:

- Для .NET Framework
- **BackgroundService** для .NET Core (.NET 8.0+, OS Windows)

## ServiceBase

Служба Windows (.NET Framework) создаёт класс, наследник от **ServiceBase** в пространстве имен System.ServiceProcess. Прогеру предлагается  реализовать виртуальные методы базового класса OnStart и OnStop, которые задают действия, подлежащие выполнению при запуске (остановке) службы, что собственно и есть суть и назначение Службы Виндовз. Регистрация Службы в этом случае производится с помощью утилиты installUtil.exe, в .Net Core это делается утилитой SC.exe.

Реализовать службу на .NET Core (в моем случае .NET 9) не сложнее, но по другому, шаблон проекта теперь называется Worker Service (Microsoft), а рабочий класс наследуется от **BackgroundService**.

## BackgroundService Worker

Шаблон Worker Service:

```csharp
namespace Svc2;

public class Worker : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            var time = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            Console.WriteLine($"Worker running at: {time}");
            await Task.Delay(1000, stoppingToken);
        }
    }
}
```

Класс Worker наследован от BackgroundService и наш проект запускается и работает как консольное приложение но это еще не служба. Чтобы сделать из него Windows Service надо добавить в зависимости пакет Microsoft.Extensions.Hosting.WindowsServices, это сделает наш  класс Worker способным реагировать на команды запуска и остановки сервиса через стандартную консоль.

Создание проекта [через CLI](https://learn.microsoft.com/ru-ru/dotnet/core/tools/dotnet-new-sdk-templates#web-others):

```bash
dotnet new worker --name <Project.Name>
```

Класс Worker изменим следующим образом, добавим кое что

```csharp
namespace Svc2;

public class Worker : BackgroundService {
    protected override async Task ExecuteAsync(CancellationToken stoppingToken) {
        // Service started
    }

    public override async Task StopAsync(CancellationToken cancellationToken) {
        // Service stoped
        await base.StopAsync(cancellationToken);
    }
}
```

Собственно код для сервиса у нас готов, теперь надо его выложить куда то, где он будет работать, то есть Опубликовать (Publish) наш проект.

Для того, Чтобы наш сервис был виден в Консоли Управления Службами Windows воспользуемся утилитой SC.EXE. Откроем окно командной строки под админской учеткой и выполним следующую команду: 

```batch
sc.exe create "AM Telebot" binPath=D:\Projects\CoreService\_pub\Svc2.exe
```

Отлично, полный успех, теперь смотрим что у нас в консоли управления службами.

И таки да, наш AM Telebot появился в списке служб. Тут уже, в свойствах Службы, можно поменять ему пользователя и тип запуска, например на Автомат, Чтобы сам запускался при перезагрузке сервера. Еще можно задать режим восстановления при непредвиденной ошибке и падении, в общем там есть полезные настройки.

Кстати, для удаления службы используем ту же утилиту SC.exe с опцией delete и указав имя службы, вот так.

```batch
sc.exe delete "AM Telebot"
```

#Dotnet/Applications
