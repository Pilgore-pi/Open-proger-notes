
> Так как весь лишний функционал нужно убрать, то чат, рейтинг, фонетика, планы обучения идут нахуй

## Таблицы

- UserProfile
- ScheduledMaterial
- StudyMaterial
- PhoneticSection
- CommonSection
- AnswerOption
- CorrectAnswer
- Session
- Rating

* ChatMessage
* SavedChat

## Связи

| Tables                                                    | Relation |
| --------------------------------------------------------- | -------- |
| UserProfile ← ScheduledMaterial                           | 1:M      |
| UserProfile ← Session                                     | 1:M      |
| UserProfile (where Status is not student) ← StudyMaterial | 1:M      |
| StudyMaterial ← ScheduledMaterial                         | 1:M      |
| StudyMaterial ← CommonSection                             | 1:M      |
| StudyMaterial ← PhoneticSection                           | 1:M      |
| StudyMaterial ← Session                                   | 1:M      |
| CommonSection ← AnswerOption                              | 1:M      |
| CommonSection ← **CorrectAnswer**                         | 1:M      |
| PhoneticSection ← **CorrectAnswer**                       | 1:M      |
| Rating → StudyMaterial                                    | M:1      |
| Rating → UserProfile                                      | M:1      |
|                                                           |          |
| ChatMessage → SavedChat                                   | M:1      |
| SavedChat → UserProfile (From and To user)                | M:1      |

## Структура таблиц

| UserProfile                      | Тип   | Ограничения                                                              | Nullable |
| -------------------------------- | ----- | ------------------------------------------------------------------------ | -------- |
| Id (PK)                          | число | первичный ключ                                                           | NOT NULL |
| Username (может повторяться)     | текст | максимальная длина 50 символов                                           | NOT NULL |
| Password (зашифрованный)         | текст | должен быть уникальным                                                   | NOT NULL |
| Status (admin, creator, student) | текст | может принимать только следующие значения: "admin", "creator", "student" | NOT NULL |
| TheoreticalMaterialsFinished     | число | >= 0                                                                     | NOT NULL |
| PracticalMaterialsFinished       | число | >= 0                                                                     | NOT NULL |
| PhoneticMaterialsFinished        | число | >= 0                                                                     | NOT NULL |
| AverageScoresPractical           | число | >= 0                                                                     | NULL     |
| AverageScoresPhonetic            | число | >= 0                                                                     | NULL     |

| Session                                                                                 | Тип          | Ограничения    | Nullable |
| --------------------------------------------------------------------------------------- | ------------ | -------------- | -------- |
| Id (PK)                                                                                 | число        | первичный ключ | NOT NULL |
| WhenCreated                                                                             | дата и время |                | NOT NULL |
| Scores (only for sections where IsTestingQuestion=true)                                 | число        | >= 0           | NOT NULL |
| IsInterrupted                                                                           | число        | >= 0           | NOT NULL |
| StudyMaterialId (FK)                                                                    | число        | внешний ключ   | NOT NULL |
| UserProfileId (FK)                                                                      | число        | внешний ключ   | NOT NULL |
| LastSection (для того, чтобы знать, на какую секцию возвращаться при прерывании сессии) | число        | > 0            | NOT NULL |

| ScheduledMaterial    | Тип          | Ораничения     | Nullable |
| -------------------- | ------------ | -------------- | -------- |
| Id (PK)              | число        | первичный ключ | NOT NULL |
| StudyMaterialId (FK) | число        | внешний ключ   | NOT NULL |
| PlannedDateTime      | дата и время |                | NOT NULL |
| IsExpired            | число        | >= 0           | NOT NULL |
| DoneInTime           | число        | >= 0           | NULL     |
| UserProfileId (FK)   | число        | внешний ключ   | NOT NULL |

| StudyMaterial                                              | Тип          | Ограничения                                                                       | Nullable |
| ---------------------------------------------------------- | ------------ | --------------------------------------------------------------------------------- | -------- |
| Id (PK)                                                    | число        | первичный ключ                                                                    | NOT NULL |
| CreatorId (FK) (ссылка на UserProfile)                     | число        | внешний ключ                                                                      | NOT NULL |
| Type (theoretical, practical, phonetic)                    | текст        | может принимать только следующие значения: "theoretical", "practical", "phonetic" | NOT NULL |
| Title                                                      | текст        | максимальная длина 300 символов                                                   | NOT NULL |
| WhenCreated                                                | дата и время |                                                                                   | NOT NULL |
| Description                                                | текст        | минимальная длина 1 символ                                                        | NULL     |
| LanguageUnit (раздел языка: грамматика, лексика, т.д.)     | текст        | минимальная длина 3 символа                                                       | NULL     |
| Topic                                                      | текст        | минимальная длина 3 символа                                                       | NULL     |
| ScoresTotal (вычисляется по максимальным вариантам ответа) | число        | >= 0                                                                              | NOT NULL |
| PassedCount (количество ПРОХОЖДЕНИЙ, а не людей)           | число        | >= 0                                                                              | NOT NULL |

| CommonSection                                                                                                  | Тип   | Ограничения                | Nullable |
| -------------------------------------------------------------------------------------------------------------- | ----- | -------------------------- | -------- |
| Id (PK)                                                                                                        | число | первичный ключ             | NOT NULL |
| MarkdownPrompt                                                                                                 | текст | минимальная длина 1 символ | NOT NULL |
| IsTestingQuestion (если это вопрос, то он оценивается, иначе просто проставляется, типа юзер посмотрел секцию) | число | >= 0                       | NOT NULL |
| IsFreeAnswer                                                                                                   | число | >= 0                       | NOT NULL |
| StudyMaterialId (FK)                                                                                           | число | внешний ключ               | NOT NULL |
| CorrectAnswerId (FK)                                                                                           | число | внешний ключ               | NULL     |

| PhoneticSection       | Тип   | Ограничения                | Nullable |
| --------------------- | ----- | -------------------------- | -------- |
| Id (PK)               | число | первичный ключ             | NOT NULL |
| MarkdownPrompt        | текст | минимальная длина 1 символ | NOT NULL |
| GivenText             | текст | минимальная длина 1 символ | NOT NULL |
| UserAnswer            | текст | минимальная длина 1 символ | NOT NULL |
| IsListeningAvailable  | число | >= 0                       | NOT NULL |
| IsReadingAvailable    | число | >= 0                       | NOT NULL |
| IsTextInputAvailable  | число | >= 0                       | NOT NULL |
| IsVoiceInputAvailable | число | >= 0                       | NOT NULL |
| CorrectAnswerId (FK)  | число | внешний ключ               | NOT NULL |
| StudyMaterialId (FK)  | число | внешний ключ               | NOT NULL |

ограничение 1: IsListeningAvailable ИЛИ IsReadingAvailable дожен быть > 0
ограничение 2: IsTextInputAvailable ИЛИ IsVoiceInputAvailable дожен быть > 0

| AnswerOption                                                                    | Тип   | Ограничения                | Nullable |
| ------------------------------------------------------------------------------- | ----- | -------------------------- | -------- |
| Id (PK)                                                                         | число | первичный ключ             | NOT NULL |
| Scores (существуют частично правильные ответы, за которые даётся меньше баллов) | число | >= 0                       | NOT NULL |
| Text                                                                            | текст | минимальная длина 1 символ | NOT NULL |
| CommonSectionId (FK)                                                            | число | внешний ключ               | NOT NULL |

| CorrectAnswer        | Тип   | Ограничения                | Nullable |
| -------------------- | ----- | -------------------------- | -------- |
| Id (PK)              | число | первичный ключ             | NOT NULL |
| Text NOT NULL        | текст | минимальная длина 1 символ | NOT NULL |

при проверке на правильность ответа, сравнивается вариант ответа с правильным ответом и, если вариант правильный, то добавить пользователю баллы этого варианта ответа (answerOptions. scores)

> Продумать систему оценивания (%, баллы...)

| Rating               | Тип          | Ораничения     | Nullable |
| -------------------- | ------------ | -------------- | -------- |
| Id (PK)              | число        | первичный ключ | NOT NULL |
| StudyMaterialId (FK) | число        | внешний ключ   | NOT NULL |
| UserProfileId (FK)   | число        | внешний ключ   | NOT NULL |
| Value                | число        | >0 И <=10      | NULL     |

>! Два внешних ключа являются потенциальным ключом, то есть комбинация внешних ключей должна быть уникальной

# Таблицы чата

| ChatMessage     | Тип      | Ограничения                | Nullable |
| --------------- | -------- | -------------------------- | -------- |
| Id (PK)         | число    | первичный ключ             | NOT NULL |
| Text            | текст    | минимальная длина 1 символ | NOT NULL |
| SenderId (FK)   | число    | внешний ключ               | NOT NULL |
| RecieverId (FK) | число    | внешний ключ               | NOT NULL |
| TimeStamp       | Datetime |                            | NOT NULL |


## Допустимые операции над таблицами в приложении

| Table                | Operations                                                      |
| -------------------- | --------------------------------------------------------------- |
| UserProfile          | Create, Delete, Read-Write                                      |
| Status               | Create 3 rows only, Readonly                                    |
| ScheduledMaterial    | Create, Delete, Read-Write                                      |
| StudyMaterial        | Create, Delete, Read-Write                                      |
| StudyMaterialType    | Create 3 rows only, Readonly                                    |
| CommonSection        | Create, Delete, Read-Write                                      |
| PhoneticSection      | Create, Delete, Read-Write                                      |
| AnswerOption         | Create, Delete, Read-Write                                      |
| CorrectAnswer        | Create, Delete, Read-Write                                      |
| Session              | Create, CascadeDeleteOnly, Read, Write untill it's not finished |
| Rating               | Create, Delete, Read-Write                                      |
| -- предварительно -- |                                                                 |
| ChatMessage          | Create, Delete, Read-Write                                      |
| SavedChat            | Create, Delete, Read-Write                                      |

* Session не может быть удален напрямую, только через каскадное удаление

Каскадное удаление:

* Таблицы из первой колонки нужно удалять в последнюю очередь.
* Таблицы из второй колонки нужно удалять в написанном порядке. Удалять нужно только связанные записи по внешнему ключу.
* Таблицы из второй колонки отсортированы по мере увеличения зависимости от других таблиц
* При удалении проверять, существует ли удаляемая таблица или она уже удалена. (Надо ли оно. — Надо, ибо будет ошибка Runtime, когда встретится ссылка на несуществующую запись)

| Table to delete | Related tables that will be cascaded deleted (sorted by valid order)  |
| --------------- | --------------------------------------------------------------------- |
| UserProfile     | Rating, Session, ScheduledMaterial, **SavedChat**, **StudyMaterial**  |
| SavedChat       | ChatMessage                                                           |
| StudyMaterial   | Rating, Session, SceduledMaterial, PhoneticSection, **CommonSection** |
| CommonSection   | AnswerOption                                                          |


----
Fluent API позволяет создавать сложные ограничения на уровне базы данных, но в некоторых ситуациях можно использовать валидацию через метод интерфейса IValidateObject. Второй подход предпочтительнее, так как вся логика находиться в одном месте.

#Идеи_проектов/Multiverbum