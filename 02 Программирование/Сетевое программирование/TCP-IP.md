В 70-е годы 20 века были распространены большие обособленные сети компьютеров. Каждая такая сеть имела свои особенности отправки и приема сообщений, а также свои форматы сообщений. Со временем, для обеспечения возможности взаимодействия всех сетей между собой была разработана **модель организации сети OSI**

## Модель OSI

Модель OSI состоит из следующих уровней:

1) Прикладной — самый высокий уровень, уровень прикладных программ, с которыми работают пользователи. В качестве прикладных программам могут выступать: браузер, почтовый клиент, FTP клиент и т. д.
2) Представления — определяет, как должно быть представлено сообщение, в какой кодировке и с какими параметрами шифрования
3) Сеансовый — контролирует очередность пакетов данных, синхронизирует потоки (например звук и видео), обрабатывает возможные разрывы связи
4) Транспортный
5) Сетевой
6) Канальный
7) Физический — провода


Механизм отправки и получения по модели OSI

- ***Отправитель*** формирует сообщение на прикладном уровне и последовательно проходит по всем уровням вплоть до физического. На каждом уровне формируется заголовок сообщения (метаданные)

- ***Получатель*** принимает сообщение на физическом уровне и последовательно проходит все уровни модели, читая заголовки сообщения. В итоге прикладное приложение, для которого предназначено сообщение получает его содержимое

Можно сказать, что отправка и получение работают по принципу матрешки. На каждом уровне сообщение помещается в новый слой (добавляется заголовок слоя). Получатель затем разворачивает все слои

## Модель TCP / IP

Модель TCP / IP является модификацией модели OSI. TCP / IP объединяет несколько уровней OSI и дополнительно определяет, какие протоколы связи должны использоваться на каждом уровне

> Протокол связи — 

Уровни модели TCP / IP:

1) Прикладной — объединяет следующие OSI уровни:
    1) прикладной
    2) представления
    3) сеансовый
    Данные на этом уровне именуются "сообщением". Так как функции прикладного уровня, уровня представления и сеансогого могут обрабатываться одной прикладной программой, эти уровни OSI обеденены в один прикладной уровень в TCP / IP.
    На этом уровне создается заголовок сообщения (служебная информация), которая зависит от используемого протокола (HTTP, SMTP, FTP и др.)

2) Транспортный — протоколы TCP (самый популярный), UDP, SCTP, DCCP и т. д. Данный уровень описывает, как и куда (какому процессу) должно прийти сообщение. Существует специальная система адресации сетевых сообщений (система портов). Порт — это двухбайтовое неотрицательное число, представляющее адрес ресурса в сети, который может принимать или отправлять сообщения
    1) Потры `1 - 1024` — общепринятые. Используются прикладными приложениями. По умолчанию порт *80 использутся для HTTP*; *443 для HTTPS*, *53 для DNS*
    2) Порты `1025 - 49151` — зарезервированные порты организацией IANA
    3) Порты `49152 - 65535` — для любых целей. ОС автоматически генерирует порты для сетевых программ в этом диапазоне

3) Межсетевой — протокол IP (самый популярный), ARP, ICMP, IGMP, IPsec, GRE и т. д.

4) Канальный — объединяет следующие OSI уровни:
    1) Канальный
    2) Физический

Название модели TCP / IP формируется из назнваний самым популярных протоколов TCP и IP

### Описание транспортного уровня

Цель траспортного уровня заключается в обеспечении механизма передачи данных с одного порта на другой

#### Механизм работы протокола TCP

1) Сообщение делится на сегменты

2) Для каждого сегмента формируется заголовок TCP. При этом сегменты не синхронизированы. Один сегмент может прийти раньше другого или вообще потеряться в следствии, например, плохого соединения

3) В процессе приема сообщения при получении каждого сегмента сообщения получатель отправляет подтверждение того, что получатель принял сегмент. Отправитель при этом запускает таймер ожидания подтверждения, по истечении которого заново отправляет сегмент данных. Получатель может получить сообщение, но отправитель не получить подтверждение. В таком случае отправитель заново отправляет сообщение, а получатель отбрасывает его, анализируя порядковый номер сегмента (определенный в заголовке) и заново отправляет подтверждение отправителю

Структура заголовка TCP:

| Поле                         | Размер в битах | Описание                                                                                                                                                                                                                                                                             |
| ---------------------------- | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Порт отправителя             | 16             |                                                                                                                                                                                                                                                                                      |
| Порт получателя              | 16             |                                                                                                                                                                                                                                                                                      |
| Порядковый номер             | 32             | Номер первого байта текущего сегмента сообщения. Эта информация нужна для последующей синхронизации всех сегментов и формирования сообщения на стороне получателя                                                                                                                    |
| Номер подтверждения          | 32             | Номер следующего ожидаемого байта сообщения                                                                                                                                                                                                                                          |
| Длина заголовка              | 4              |                                                                                                                                                                                                                                                                                      |
| 3 выравнивающих нулевых бита | 3              |                                                                                                                                                                                                                                                                                      |
| Флаг `NS`                    | 1              | Служит для предотвращения случайного изменения или неизменения флагов `CWR` и `ECE`                                                                                                                                                                                                  |
| Флаг `CWR`                   | 1              | Флаг подтверждения о перегрузке сети от отправителя (см. флаг `ECE`)                                                                                                                                                                                                                 |
| Флаг `ECE`                   | 1              | Флаг подтверждения о перегрузке сети от получателя. Маршрутизатор при перегрузке может отправить получателю сегмент с измененным заголовком IP, тогда получатель в сегменте-подтвеждении устанавливает флаг `ECE`. В ответ отправитель также отправляет подтверждение с флагом `CWR` |
| Флаг `UGR`                   | 1              | Определеяет, содержит ли сегмент срочные данные, необходимые программе                                                                                                                                                                                                               |
| Флаг `ACK`                   | 1              | Ставится при получении сегмента получателем. Отправитель анализирует флаг и определяет, нужно ли считывать данные по **номеру подтвеждения** или нет                                                                                                                                 |
| Флаг `PSH`                   | 1              | Указывает на то, что сегмент нужно передавать программе сразу без внесения в промежуточный буфер                                                                                                                                                                                     |
| Флаг `RST`                   | 1              | Флаг, который говорит о критической ошибке. Отправитель сегмента с данным флагом не ожидает ответа и экстренно разрывает соединение. Получатель также разрывает соединение без отправки подтверждения                                                                                |
| Флаг `SYN`                   | 1              | Определяет создано ли предварительное соединение для передачи сообщения по протоколу TCP                                                                                                                                                                                             |
| Флаг `FIN`                   | 1              | Указывает на то, что у передающей стороны больше нет данных для передачи. При попытке разрыва соединения отправитель и получатель отправляют сегмент с флагом `FIN` и в ответ ожидают  подтверждение с флагом `ACK`                                                                  |
| Размер окна (буфера)         | 16             | Определяет размер буфера сегментов                                                                                                                                                                                                                                                   |
| Констрольная сумма           | 16             | Хэш-значение, вычисляемое на основе заголовка и содержимого всего сообщения                                                                                                                                                                                                          |
| Указатель на срочные данные  | 16             |                                                                                                                                                                                                                                                                                      |
| (Необязательные параметры)   | ?              | Часть заголовка с неизвестной длиной. Информация о размере заголовка храниться в поле "Длина заголовка"                                                                                                                                                                              |

#### Механизм работы UDP протокола

В отличие от TCP протокола, UDP:

- Не контролирует целостность передаваемых данных
- Не создает предварительного подключения
- Не анализирует перегрузку сети
- Не ожидает подтверждения о получении сегментов
- Не занимается управлением размера окна
- Гораздо быстрее
- Заголовок UDP занимает всего 8 байт

Структура заголовка UDP:

| Поле                             | Размер в битах | Описание       |
| -------------------------------- | -------------- | -------------- |
| Порт отправителя                 | 16             | необязательное |
| Порт получателя                  | 16             |                |
| Длина заголовка вместе с данными | 16             |                |
| Контрольная сумма                | 16             | необязательное |

### Описание межсетевого уровня

Цель межсетевого уровня — обеспечить передачу данных с одного устройства на другое.

Каждое устройство в сети имеет идентификатор, называемый IP-адресом

#### Механизм работы протокола IPv4

Согласно протоколу, сформированные на предыдущем этапе сегменты с заголовками TCP, UDP или др. дополняются IP-заголовком. После этой операции сегмент становится *пакетом*

Структура заголовка IPv4:

| Поле                   | Размер в битах | Описание                                                               |
| ---------------------- | -------------- | ---------------------------------------------------------------------- |
| Номер версии IP адреса | 4              |                                                                        |
| Длина заголовка        | 4              |                                                                        |
| Тип обслуживания       | 8              | Набор битовых флагов, который определяет параметры обслуживания пакета |
| IPv4 отправителя       | 32             |                                                                        |
| IPv4 получателя        | 32             |                                                                        |
| (Необязательные поля)  |                |                                                                        |

Источники:

1) [AlekOS (YouTube)](https://www.youtube.com/watch?v=EJzitviiv2c)
2) Perplexity

#Network