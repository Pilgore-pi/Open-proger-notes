# https://docs.umbraco.com/umbraco-cms/tutorials/getting-started-with-entity-framework-core

> **Entity Framework Core (EF Core)** — это современный кроссплатформенный ORM (Object-Relational Mapping) фреймворк с открытым исходным кодом для .NET, разработанный Microsoft. Он позволяет работать с базой данных через объекты C#, избавляя от необходимости писать SQL-запросы вручную и упрощая доступ к данным в приложениях на .NET

## Совместимость

Существует 2 глобальные версии Entity Framework

- **Entity Framework** — устаревшая версия, используемая эксклюзивно под Windows

- **EF Core** — open-source фреймворк, переписанный с нуля, современная и кроссплатформенная версия Entity Framework

| Разрез анализа | EF Core | Entity Framework |
|--|--|--|
| Операционные системы | Windows, Linux, MacOS | Windows |
| СУБД | Все популярные реляционные СУБД, нереляционные СУБД и СУБД от Microsoft | Только реляционные СУБД (SQL Server, Oracle, MySQL и др.) |
| [Платформа .NET](https://learn.microsoft.com/en-us/ef/core/miscellaneous/platforms) | .NET Core 3.1+, .NET 5+, .NET Standard 2.0+ | .NET 5+ |

## Провайдеры базы данных

EF Core поддерживает множество реляционных и нереляционных СУБД:

- Microsoft SQL Server — встроенный провайдер
- PostgreSQL — встроенный провайдер
- MySQL
- SQLite — встроенный провайдер
- Oracle
- NoSQL (например, Azure Cosmos DB)

**Провайдер базы данных (или провайдер БД)** — это компонент, который обеспечивает взаимодействие приложения с конкретной системой управления базами данных (СУБД). Он реализует все необходимые механизмы для подключения, выполнения запросов, получения и сохранения данных, а также обработки специфики выбранной СУБД.

В контексте .NET и, в частности, Entity Framework Core, провайдер БД — это библиотека, которая адаптирует универсальный API EF Core под конкретную СУБД (например, Microsoft SQL Server, PostgreSQL, MySQL, SQLite и др.). Каждый провайдер реализует поддержку специфического синтаксиса SQL, особенностей транзакций, типов данных и других нюансов работы с выбранной базой данных

> **Встроенный провайдер EF Core** — это официальный компонент, разрабатываемый и поддерживаемый командой Microsoft специально для EF Core и определённых СУБД. Он проходит тщательное тестирование, имеет гарантии совместимости с новыми версиями EF Core и получает своевременные обновления и исправления

> **Сторонний провайдер** создаётся независимыми разработчиками или компаниями. Качество сторонних провайдеров, скорость обновления и совместимость с новыми версиями EF Core могут отличаться, так как ответственность за поддержку лежит на внешних авторах. Иногда сторонние провайдеры могут не поддерживать все возможности EF Core или реализовывать их иначе, чем встроенные

> **ORM (object-relational mapping)** — это вид технологий, которые позволяют работать с реляционными базами данных через объектно-ориентированный код, не прибегая к написанию SQL-запросов вручную. Вместо того чтобы оперировать таблицами, строками и столбцами, разработчик работает с привычными C#-классами и объектами, а ORM-фреймворк автоматически преобразует операции с объектами в соответствующие SQL-запросы и обратно

## Моделирование

Поддерживается 2 подхода к моделированию:

- **Code First**: сначала описывается модель в коде, затем по ней создаётся или обновляется база данных

- **Database First**: можно сгенерировать модель на основе уже существующей базы данных

При любом подходе можно использовать 2 стиля описания моделей БД:

- **Аннотации данных (Data annotations)**: Ограничения и метаинформация о моделях описывается через атрибуты в **POCO классах**

- **Fluent API**: Модели описываются цепочкой вызовов методов в реализациях абстрактного класса `DbContext`. Данный стиль более универсальный и позволяет более тонко настраивать модели

> Термин **Fluent API** означает стиль проектирования интерфейсов, при котором методы возвращают сам объект (или другой объект, участвующий в конфигурации), что позволяет вызывать методы цепочкой (method chaining). Такой подход делает код более читаемым и похожим на естественный язык, а также облегчает конфигурирование и настройку сложных объектов или операций

### POCO классы

> **POCO классы (Plain Old CLR Object)** — это простые классы .NET, которые не зависят от каких-либо внешних библиотек или фреймворков и не наследуются от специальных базовых классов. Их задача — просто описывать структуру данных, обычно с помощью автосвойств, без бизнес-логики или специфических интерфейсов

Признаки POCO класса:

- Не наследуется от специальных базовых классов фреймворков (например, не наследуется от EntityObject)

- Не содержит атрибутов или кода, привязывающего его к инфраструктуре

- Содержит только свойства и, возможно, простые методы для работы с данными

## Миграции

> **Миграции в EF Core** — это механизм управления изменениями схемы базы данных на протяжении жизненного цикла приложения

Миграции позволяют постепенно изменять структуру БД, синхронизируя её с моделью данных в коде без необходимости вручную писать SQL-скрипты для каждого изменения

**Миграции в EF Core по умолчанию стремятся сохранить данные**, но всё зависит от характера изменений:

- **Добавление** новых столбцов, таблиц, индексов — эти операции безопасны, данные не теряются

- **Удаление** столбцов или таблиц — данные, находящиеся в удаляемых объектах, будут потеряны безвозвратно

- **Переименование** столбцов или таблиц — если не указать явно, что это переименование (а не удаление и создание заново), можно потерять данные. EF Core не всегда может корректно определить переименование, поэтому такие операции лучше выполнять вручную или корректировать миграцию

- **Изменение типа** столбца — возможна потеря данных, если тип несовместим или происходит обрезка значений

## Запросы через LINQ

> Для взаимодействия с базой данных через EF Core, принято использовать язык **LINQ to entities**. [Интерфейс IQueryable]() позволяет создавать оптимизированные запросы для работы с данными в удаленной базе

Запросы LINQ транслируются в SQL, понятный конкретному провайдеру базы данных

> **Reverse engineering** — обратное проектирование (разработка). В контексте ORM это анализ структуры БД для автоматического создания классов

## Отслеживание изменений

EF Core автоматически отслеживает изменения в сущностях, чтобы при вызове SaveChanges() сформировать и выполнить нужные SQL-команды (INSERT, UPDATE, DELETE)

- Можно выполнять операции над данными без отслеживания, сразу применяя операции над данными с помощью методов расширения `ExecuteUpdate()`, `ExecuteDelete()`

EF Core позволяет анализировать состояние записей БД и выполнять отладку отслеживания изменений

Человеко-читаемые логи трекера изменений данных содержится в свойстве `DbContext`:

```cs
ChangeTracker.DebugView
```

Пример значения `DebugView`:

```text
Blog {Id: -2} Added
  Id: -2 PK Temporary
  Name: 'Visual Studio Blog'
  Posts: [{Id: -2}]
Blog {Id: -1} Added
  Id: -1 PK Temporary
  Name: '.NET Blog'
  Posts: [{Id: -1}]
Post {Id: -2} Added
  Id: -2 PK Temporary
  BlogId: -2 FK
  Content: 'If you are focused on squeezing out the last bits of perform...'
  Title: 'Disassembly improvements for optimized managed debugging'
  Blog: {Id: -2}
  Tags: []
Post {Id: -1} Added
  Id: -1 PK Temporary
  BlogId: -1 FK
  Content: 'Announcing the release of EF Core 5.0, a full featured cross...'
  Title: 'Announcing the Release of EF Core 5.0'
  Blog: {Id: -1}
```

У всех записей моделей данных есть свойство `State` (`enum EntityState`), предоставляющее дополнительный разрез аналитики изменений данных

| Статус      | Значение | Описание |
| :---------- | :------- | :------- |
| `Detached`  | 0        | Запись не отслеживается в контексте данных |
| `Unchanged` | 1        | Запись отслеживается и существует в БД. Атрибуты записи не изменялись |
| `Deleted`   | 2        | Запись отслеживается и существует в БД. Запись помечена на удаление |
| `Modified`  | 3        | Запись отслеживается и существует в БД. Некоторые или все атрибуты записи были изменены |
| `Added`     | 4        | Запись отслеживается, но еще не добавлена в базу данных |

## Транзакции и конкурентность

- Автоматическое управление транзакциями при сохранении данных.

- Поддержка оптимистичной конкурентности для предотвращения конфликтов при одновременном изменении данных несколькими пользователями

## Кэширование и производительность

Встроенное кэширование первого уровня (в пределах одного контекста).

Возможность отключать отслеживание изменений для повышения производительности при только чтении данных

## Схема работы с Entity Framework Core

Данные, используемые ORM, можно разделить на несколько слоев:

- База данных SQL
- ООП модели SQL таблиц (.NET классы без бизнес-логики)
- Сервисы управления данными (программные модули)

### Начало работы

> Если ORM используется в проекте ASP.NET, то никаких доп. пакетов устанавливать не требуется. Если приложение создано на основе шаблона, который из коробки не содержит предустановленных пакетов EF Core, то необходимо их установить вручную через Nuget менеджер, согласно [провайдеру БД](), который используется в приложении


#### Контекст базы данных

Контекст базы данных, представляемый наследниками класса `DbContext` — это основой API для взаимодействия с фактическими данными БД 

```csharp
using Microsoft.EntityFrameworkCore;

// Реализует IDisposable
public class ApplicationContext : DbContext
{
    // необязательная инициализация
    public DbSet<User> Users => Set<User>();
    
    // создание БД, если она не создана
    public ApplicationContext() => Database.EnsureCreated();
 
    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        // Создание или использование файла .db по относительному пути
        optionsBuilder.UseSqlite("Data Source=app.db");
    }
}
```

Контекст БД можно настраивать вручную, редактируя классы `DbContext`, или создавать миграции с помощью EF Core Tools. EF Core Tools предоставляет CLI через команды **`dotnet ef`** или API через PowerShell. IDE JetBrains Rider позволяет управлять миграциями через GUI (ПКМ по проекту, вкладка меню "Entity Framework Core").

EF Core Tools упрощает работу программиста, беря на себя поддержку контекстных классов `DbContext`, генерируя необходимый код.

* `bool EnsureCreated()` — создает БД или, в случае когда БД создана, но не имеет таблиц, создает таблицы в соответствии со схемой данных. Если какие-либо таблицы уже созданы, метод не оказывает никакого влияния. Возвращает `true`, если БД была создана с использованием этого метода, в противном случае — `false`

Применение `ApplicationContext`

```csharp
using var db = new ApplicationContext();

// создаем два объекта User
var tom   = new User { Name = "Tom"  , Age = 33 };
var alice = new User { Name = "Alice", Age = 26 };

// добавляем их в бд
db.Users.Add(tom);   // SQL: INSERT dfgmsldkfjg;hshfdg;
db.Users.Add(alice);
db.SaveChanges();    // фиксация транзакции
Console.WriteLine("Объекты успешно сохранены");

// получаем объекты из бд и выводим на консоль
var users = db.Users.ToList();
Console.WriteLine("Список объектов:");
foreach (User u in users)
    Console.WriteLine($"{u.Id}.{u.Name} - {u.Age}");
```

После этого будет сгенерирован код класса `<DB_FILE_NAME>Context : DbContext` и классы на основе таблиц SQL. Все эти классы являются `partial`. Программисту доступен минимально необходимый функционал этих классов.

#DB #Dotnet #Dotnet/EntityFramework
