# https://docs.umbraco.com/umbraco-cms/tutorials/getting-started-with-entity-framework-core

> **Entity Framework Core** -- это ORM-технология, основанная на экосистеме .NET, от компании Microsoft. Фреймворк является open-source проектом, который поддерживает несколько встроенных провайдеров для поддержки различных СУБД:

* MS SQL Server
* SQLite
* PostgreSQL

Также существуют сторонние провайдеры (например для MySQL). Полный список провайдеров можно увидеть [здесь]() (ссылка на заметку Провайдеры БД)

> ORM (object-relational mapping) -- это система сопоставления данных......

Entity Framework позволяет абстрагироваться от фундаментальных понятий БД, таких как таблицы, индексы, триггеры и так далее. Эти понятия заменяются объектами .NET, что позволяет обеспечить независимость кода логики приложения от используемой СУБД.

> Для взаимодействия с базой данных через **Entity Framework**, принято исполоьзовать язык **LINQ to entities**

> **Reverse engineering** — обратное проектирование (разработка). В контексте ORM это анализ структуры БД для автоматического создания классов

### Схема работы с Entity Framework Core

Данные, используемые ORM, можно разделить на несколько слоев:

- База данных SQL
- ООП модели SQL таблиц (.NET классы без бизнес-логики)
- Сервисы управления данными (программные модули)

## Начало работы

Чтобы использовать фреймворк, нужно добавить соответствующий пакет Nuget. К примеру, для использования СУБД SQLite необходимо установить эти пакеты.

```
// Проектирование БД
Microsoft.EntityFrameworkCore.Design

// SQLite
Microsoft.EntityFrameworkCore.Sqlite

// Позволяет делать миграции через консоль
Microsoft.EntityFrameworkCore.Tools
```

> Если ORM используется в проекте ASP.NET, то никаких доп. пакетов устанавливать не требуется

> (ПРОВЕРИТЬ)SQLite не позволяет разграничивать доступ к данным и делать транзакции, но позволяет создавать триггеры

#### Контекст базы данных

```csharp
using Microsoft.EntityFrameworkCore;

// Implements IDisposable
public class ApplicationContext : DbContext
{
    // необязательная инициализация
    public DbSet<User> Users => Set<User>();
    
    // создание БД, если она не создана
    public ApplicationContext() => Database.EnsureCreated();
 
    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        // Создание или использование файла .db по относительному пути
        optionsBuilder.UseSqlite("Data Source=app.db");
    }
}
```

Классы `DbContext` можно настраивать вручную или создавать миграции с помощью инструмента CLI **dotnet ef**. При использовании `dotnet ef` можно вообще не редактировать `DbConext`, так как при выполнении миграции, указывается класс контекста БД, для которого `dotnet ef` генерирует необходимый код

* `bool EnsureCreated()` — создает БД или, в случае когда БД создана, но не имеет таблиц, создает таблицы в соответствии со схемой данных. Если какие-либо таблицы уже созданы, метод не оказывает никакого влияния. Возвращает `true`, если БД была создана с использованием этого метода, в противном случае — `false`

Применение `ApplicationContext`

```csharp
using var db = new ApplicationContext();

// создаем два объекта User
var tom   = new User { Name = "Tom"  , Age = 33 };
var alice = new User { Name = "Alice", Age = 26 };

// добавляем их в бд
db.Users.Add(tom);   // SQL: INSERT dfgmsldkfjg;hshfdg;
db.Users.Add(alice);
db.SaveChanges();    // фиксация транзакции
Console.WriteLine("Объекты успешно сохранены");

// получаем объекты из бд и выводим на консоль
var users = db.Users.ToList();
Console.WriteLine("Список объектов:");
foreach (User u in users)
    Console.WriteLine($"{u.Id}.{u.Name} - {u.Age}");
```

## Создание базы данных

Создание делается через "миграции". Для этого нужно выполнить команду в консоли менеджера пакетов (в Visual Studio):

```powershell
Add-Migration InitialCreate

// Удаление миграции выполняется через команду:
Remove-Migration
```

После выполнения миграции, будет сгенерирован код для создания всех сущностей и связей БД. При этом в проекте должна появиться папка "Migrations"

**Запуск миграции**

Это команда запустит все созданные миграции и создаст файл app.db:
```powershell
Update-Database
```

В IDE JetBrains Rider нет консоли менеджера пакетов, вместо нее используется специальный конструктор миграций, который можно вызвать в контекстном меню проекта (`ПКМ > Entity Framework Core`). Однако, чтобы использовать конструктор миграций, нужно установить расширение EF Core Tools

Универсальным способом является CLI `dotnet ef`


### Как работают миграции

Когда создается миграция, Entity Framework Core генерирует код, который описывает изменения в схеме базы данных. Эти изменения могут включать создание новых таблиц, добавление или удаление столбцов, изменение типов данных и т.д. Когда вы применяете миграцию, Entity Framework Core выполняет эти изменения в базе данных.

Применение миграций при каждом запуске приложения не должно удалять данные из базы данных, если миграции созданы и применяются правильно. Миграции в Entity Framework Core предназначены для управления изменениями в схеме базы данных без потери данных. Однако, есть несколько нюансов, которые стоит учитывать.

Применение миграций при запуске приложения — это обычная практика, которая позволяет автоматически обновлять схему базы данных до последней версии. Это особенно полезно в средах разработки и тестирования

#### Открытие файла `app.db`

Для октрытия файла потребуется специальное ПО, поддерживающее просмотр файлов БД, например [DB Browser for SQLite](https://sqlitebrowser.org/dl/)

#### Использование существующей БД

Необходимо подключить 2 пакета Nuget:

* `Microsoft.EntityFrameworkCore.Sqlite`
* `Microsoft.EntityFrameworkCore.Design` — необходим для **reverse engineering** (создания классов по таблицам БД)

Для выполнения обратного проектирования, нужно выполнить специальную команду

```
Scaffold-DbContext "строка подключения" провайдер_бд
```

Пример:

```
Scaffold-DbContext "Data Source=D:\\app.db" Microsoft.EntityFrameworkCore.Sqlite
```

После этого будет сгенерирован код класса `<DB_FILE_NAME>Context : DbContext` и классы на основе таблиц SQL. Все эти классы являются `partial`. Программисту доступен минимально необходимый функционал этих классов.

#DB #Dotnet #Dotnet/EntityFramework
