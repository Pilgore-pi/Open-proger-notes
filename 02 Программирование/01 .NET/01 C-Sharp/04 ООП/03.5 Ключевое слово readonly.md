https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/method-parameters#ref-readonly-modifier
https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/struct

Ключевое слово `readonly` используется в следующих 5 контекстах:

1. Объявление полей
2. Определение структур только для чтения
3. Члены структур, не изменяющие данные структуры
4. Возврат неизменяемых ссылок в методах и аксессорах `get`
5. Параметры методов, передаваемые по ссылке без возможности переназначения этой ссылки (`ref readonly`)

## 1 Поля только для чтения

Ключевое слово `readonly` ограничивает доступ к полю. Значение задается один раз при вызове конструктора. После инициализации поле становится доступным только для чтения

### Отличия read-only поля от константы

Особенности констант:

- Константы инициализируются сразу и уже определены на этапе компиляции
- Констатны могут представлять только примитивные типы
- Константы неявно являются статическими

Особенности read-only полей:

- Поля только для чтения вычисляются **во время выполнения программы**, в конструкторе объекта
- Поля могут представлять любые типы
- Нестатические read-only поля всегда относятся к экземпляру, а не к типу

### Свойства только для чтения

Можно применять модификатор `readonly` к свойствам и индексаторам, только, если они имеют аксессор `init`

Может возникнуть вопрос. Зачем применять модификатор `readonly`, если, по факту, свойство и так доступно только для чтения? — Наличие модификатора позволяеет компилятору выполнять оптимизации производительнсти

## 2 Неизменяемые структуры

Неизменяемые структуры имеют следующие ограничения:

- Любое поле должно быть read-only
- Все свойства должны быть только для чтения или быть `init-only`, то есть вместо сеттера `set` иметь `init`

Все остальные члены структур только для чтения неявно тоже являются read-only

В неизменяемых структурах все типы значений неизменяемы, а ссылочные данные не могут изменять ссылки, но данные находящиеся по ссылке не имеют ограничений. Например, есть поле `readonly List<int> list;`. Нельзя переназначить это поле, присвоив новую ссылку на объект, но можно у `list` вызвать методы `Add()`, `Remove()` и т. д., что поменяет состояние поля

* Можно объявлять структуры-записи только для чтения (`readonly record struct`)

### Копирование неизменяемых структур. Оператор with

При попытке установить новое значение для члена read-only структуры возникает ошибка компиляции, поэтому необходимо создавать полностью новую структуру с измененными данными, если есть такая необхоимость. Оператор `with` предназначен упростить написание подобного кода:

Структура только для чтения:

```cs
public readonly struct Coords {
    public Coords(double x, double y) {
        X = x;
        Y = y;
    }

    public double X { get; init; }
    public double Y { get; init; }

    public override string ToString() => $"({X}, {Y})";
}
```

Копирование структуры без оператора `with`:

```cs
public static void Main() {
    var p1 = new Coords(0, 0);
    Console.WriteLine(p1);  // output: (0, 0)

    var p2 = new Coords { X = 3, Y = p1.Y };
    Console.WriteLine(p2);  // output: (3, 0)

    var p3 = new Coords { X = 1, Y = 4 };
    Console.WriteLine(p3);  // output: (1, 4)
}
```

Копирование структуры с оператором `with`:

```cs
public static void Main() {
    var p1 = new Coords(0, 0);
    Console.WriteLine(p1);  // output: (0, 0)

    var p2 = p1 with { X = 3 };
    Console.WriteLine(p2);  // output: (3, 0)

    var p3 = p1 with { X = 1, Y = 4 };
    Console.WriteLine(p3);  // output: (1, 4)
}
```

#C-Sharp #OOP
