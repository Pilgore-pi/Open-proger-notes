## Структура таблиц

| Test                         | Тип      | Ограничения                     | Nullable |
| ---------------------------- | -------- | ------------------------------- | -------- |
| Id (PK)                      | int      | первичный ключ                  | NO       |
| Title                        | nvarchar | минимальная длина 1 символ      | NO       |
| Description                  | nvarchar | минимальная длина 1 символ      | YES      |
| Topic                        | nvarchar | минимальная длина 1 символ      | YES      |
| CreationDate                 | DateTime | `default current datetime`      | NO       |
| AllowPageNavigationBackwards | tiny     | `default false`                 | NO       |
| AllowPageNavigationForwards  | tiny     | `default false`                 | NO       |
| AuthorID (FK)                | int      | `default -1` (`"current user"`) | NO       |

| User          | Тип      | Ограничения                 | Nullable |
| ------------- | -------- | --------------------------- | -------- |
| Password (PK) | int      | первичный ключ              | NO |
| Name          | nvarchar | минимальная длина 2 символа | NO |
| IsAdmin       | tiny     | `default false`             | NO |

| UserStatistics    | Тип   | Ограничения                          | Nullable |
| ----------------- | ----- | ------------------------------------ | -------- |
| UserID (FK)       | int   | внешний ключ                         | NO |
| TestID (FK)       | int   | внешний ключ                         | NO |
| Attempts          | int   | `>= 0`, `default 0`                  | NO |
| AverageScores     | float | `>= 0`, `<= max scores`              | NO |
| LastAttemptScores | float | `>= 0`, `default 0`                  | NO |
| LastSectionIndex  | int   | `>= -1` // -1, when test is finished | NO |
| (PK)              |       | Составной ключ: UserID, TestID       | NO |

| Section             | Тип      | Ограничения                | Nullable |
| ------------------- | -------- | -------------------------- | -------- |
| Id (PK)             | int      | первичный ключ             | NO       |
| Prompt              | nvarchar | минимальная длина 1 символ | NO       |
| Priority            | int      | `default 0`                | NO       |
| TestID (FK)         | int      | внешний ключ               | NO       |
| AllowFreeUserAnswer | tiny     | `default true`             | NO       |

| SectionAnswerRelation | Тип | Ограничения                         | Nullable |
| --------------------- | --- | ----------------------------------- | -------- |
| SectionID (FK)        | int | первичный ключ                      | NO |
| AnswerID (FK)         | int | минимальная длина 1 символ          | NO |
| (PK)                  |     | Составной ключ: SectionID, AnswerID | NO |

| Answer          | Тип      | Ограничения                | Nullable |
| --------------- | -------- | -------------------------- | -------- |
| Id (PK)         | int      | первичный ключ             | NO |
| Text            | nvarchar | минимальная длина 1 символ | NO |
| AnswerKind (FK) | int      | —                          | NO |

| AnswerKind | Тип      | Ограничения                | Nullable |
| ---------- | -------- | -------------------------- | -------- |
| Id (PK)    | int      | первичный ключ             | NO |
| Text       | nvarchar | минимальная длина 1 символ | NO |
| PREDEFINED |          | `"option"`                 |          |
| PREDEFINED |          | `"correct"`                |          |
| PREDEFINED |          | `"semicorrect"`            |          |

## Схема связей

| Table 1 | Relation | Table 2        |
| ------- | -------- | -------------- |
| Test    | 1:1      | User           |
| Test    | 1:M      | UserStatistics |
| Test    | 1:M      | Section        |
| User    | 1:M      | UserStatistics |
| Section | M:M      | Answer         |
| Answer  | M:1      | AnswerKind     |

## Виртуальные таблицы

> Узнать, есть ли простой способ по ID получать доступ ко всем атрибутам таблицы? Это часто пригождается

| TestInfo                     |
| ---------------------------- |
| Id (PK)                      |
| Description                  |
| Topic                        |
| CreationDate                 |
| AllowPageNavigationBackwards |
| AllowPageNavigationForwards  |
| AuthorName                   |
| Attempts                     |
| AverageScores                |
| LastAttemptScores            |
| LastSectionIndex             |

```sql
// pseudo query
select * from User  where User.Id = CurrentUser.Id
join UserStatistics on UserStatistics.UserId = User.Id
join Test           on Test.Id = UserStatistics.TestId
```

## Кастомные операции

##### Непосредственное удаление записи Section

```
1. Удалить Section, где ID = _ID
2. select AnswerID as _AnswerID from SectionAnswerRelation
    where SectionID = _ID
3. Для каждой записи из полученной выборки:
    1. Удалить эту запись
    2. select count(*) from SectionAnswerRelation
        where AnswerID = _AnswerID
    3. Если count() = 0, тогда удалить запись в Answer, где ID = _AnswerID
```


#Идеи_проектов #Идеи_проектов/Multiverbum