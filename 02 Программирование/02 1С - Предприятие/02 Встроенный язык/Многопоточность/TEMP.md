
## Отказ от модальности

Отказ от модальности начался в платформе 8.3.3 (июль 2013 года). Для того, чтобы обеспечить работу с базами 1С через браузер, в том числе на мобильных устройствах, потребовалось отказаться в конфигурациях от использования модальных окон, которые при открытии блокируют весь интерфейс браузера, включая остальные открытые окна и вкладки

Асинх методы доступны только на клиенте

Во встроенном языке существуют схожие способы реализации асинхронности, которые уже давно присутствуют в JavaScript:

- Использование методов обратного вызова (callback)
- Использование Обещаний (promise)

## Принцип работы методов обратного вызова (callback)

Представим, что у нас есть такая структура кода:

```bsl
Procedure MainSyncProc()
    
    // какие-то действия
    
    AsyncProc(new ОписаниеОповещения("OnCompleted"));
    
    // какие-то действия
    
EndProcedure

// Метод обратного вызова, callback
Procedure OnCompleted() //ПриЗавершении

EndProcedure
```

После вызова асинхронного метода `AsyncProc()` управление вернется к коду, вызвавшему этот метод (`MainSyncProc()`), не дожидаясь, когда `AsyncProc()` завершит свою работу. Когда `AsyncProc()` отработает, он оповестит о своем завершении и предоставит доступ к результату.

Оповещение о завершении происходит при помощи вызова процедуры `OnCompleted()`, описание которой передается в `AsyncProc()`. Эта процедура и называется методом обратного вызова (англ. callback – дословно “обратный звонок”), поскольку позволяет асинхронному методу `AsyncProc()` “связаться” с вызвавшим его кодом (`MainSyncProc()`)

Пусть есть следующий код на языке JavaScript:

```js
console.log('1');
console.log('2');
console.log('3');
```

Этот код последовательно выводит в консоль числа 1, 2 и 3. Это синхронный код.

Теперь модифицируем его – реализуем вывод числа 2 в консоль по таймеру, через 2 секунды:

```js
console.log('1');
setTimeout(LogTwoSecondsLater, 2000);
console.log('3');

function LogTwoSecondsLater() {
    console.log('2')
}
```

Асинхронная функция `setTimeout()` ожидает 2 секунды (вторым параметром функции указан период ожидания в миллисекундах: 2000 мс = 2 с), а затем вызывает функцию обратного вызова `LogTwoSecondsLater()`, переданную в качестве первого параметра.

Функция `setTimeout()` не блокирует основной поток. Скрипт не “зависнет” на 2 секунды, а продолжит выполнение. В консоль будут выведены числа 1, 3. И только через 2 секунды, когда сработает таймер, будет вызвана функция `LogTwoSecondsLater()`, в консоль будет выведено число 2.

Но во встроенном языке “1С:Предприятие” нельзя указывать функцию в качестве параметра другого метода. Поэтому приведенный ниже код иллюстрирует логику работы асинхронных функций с использованием метода обратного вызова, но является *синтаксически некорректным*:

```bsl
Процедура ДлительнаяЗагрузка()
    ЗагрузитьАсинхронно(ВыполнитьДействияПослеЗагрузки);
КонецПроцедуры

Процедура ЗагрузитьАсинхронно(МетодОбратногоВызова)
    //Действия для загрузки данных...
    МетодОбратногоВызова();
КонецПроцедуры

Процедура ВыполнитьДействияПослеЗагрузки()
    //Оповещение, что загрузка завершена. Действия после завершения загрузки...
КонецПроцедуры
```

Во встроенном языке асинхронный код с использованием методов обратного вызова реализован при помощи объекта `ОписаниеОповещения`. Этот объект содержит описание метода обратного вызова:

- Какую процедуру нужно выполнить после завершения асинхронного метода?
- В каком модуле она располагается?
- Какие параметры нужно в нее передать?
- Для того, чтобы правильно составить описание метода обратного вызова, корректно описать все необходимые параметры, удобно использовать Синтакс-помощник. В нем указаны все параметры метода обратного вызова, который будет выполнен при завершении асинхронного метода.

Например, для метода `ПоказатьВопрос()` после ответа пользователя на вопрос будет вызвана процедура со следующими параметрами:

- `РезультатВопроса`
- `ДополнительныеПараметры`

Рассмотрим пример. В нем задается вопрос пользователю, на который он может ответить Да или Нет. После того, как пользователь ответит на вопрос, в сообщении выводим, сколько времени ему потребовалось на ответ.

Для реализации такого функционала используется следующий код в модуле формы:

```bsl
&НаКлиенте
Процедура ЗадатьВопрос(Команда)
    
    ДопПараметры = Новый Структура("ВремяНачала", ТекущаяДата());
    ОпОп = Новый ОписаниеОповещения("ПоказатьВопросЗавершение", ЭтотОбъект, ДопПараметры);
    ПоказатьВопрос(ОпОп, "Выполнить загрузку?", РежимДиалогаВопрос.ДаНет);
    Сообщить("Начало загрузки");
    
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьВопросЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
    
    Сообщить("Выбран вариант: " + РезультатВопроса);
    Если ТипЗнч(ДополнительныеПараметры) = Тип("Структура") Тогда
        
        ВремяНачала = Неопределено;
        Если ДополнительныеПараметры.Свойство("ВремяНачала", ВремяНачала) Тогда
            
            ЗатраченноеВремя = ТекущаяДата() - ВремяНачала;
            ТекстСообщения = СтрШаблон(
                "Затраченное время: %1 %2",
                    ЗатраченноеВремя,
                    "с"
            );
            Сообщить(ТекстСообщения);
            
        КонецЕсли;
        
    КонецЕсли;
    
КонецПроцедуры
```