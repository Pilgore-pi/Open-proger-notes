https://habr.com/ru/companies/rvision/articles/723050/

Возможности планировщика задач:

- Запуск исполняемого файла;
- Выполнение batch или PowerShell скрипта
- Отправка сообщения электронной почты
- Отображение системного диалогового окна с сообщением

Задание активируется по одному или нескольким триггерам:

- При возникновении определенного системного события
- В определенное время
- В определенное время по ежедневному расписанию
- В определенное время в еженедельном расписании
- В определенное время по ежемесячному расписанию
- В определенное время по ежемесячному расписанию на неделю
- Когда компьютер входит в состояние простоя
- Когда задача зарегистрирована
- При загрузке системы
- Когда пользователь входит в систему
- При изменении состояния сеанса сервера терминала

## API планировщика задач

Планировщик задач предоставляет API в следующих формах:

- Планировщик задач 2.0. Интерфейсы и объекты предоставляются для C++, а также для разработки скриптов соответственно.

- Планировщик задач 1.0. Интерфейсы предоставляются только для разработки C++.

Кроме того, поддерживается COM-интерфейс, через который можно взаимодействовать с планировщиком

Windows "из коробки" поддерживает API для С++ (через COM), Visual Basic и XML

Чтобы зарегистрировать задачу, определенную в XML, можно использовать функцию `ITaskFolder::RegisterTask` (`TaskFolder.RegisterTask` для создания скриптов) или средство командной строки `Schtasks.exe`. Если вы используете средство `Schtasks.exe` (расположено в каталоге `"C:\Windows\System32"`), то для регистрации задачи можно использовать следующую команду:

```
schtasks /create /XML <path to the XML file containing the task definition> /tn <task name>
```

В следующем примере показано, как определить задачу с одним действием выполнения: запуск Блокнота (notepad.exe), одним триггером времени, запускающим задачу в определенное время, и несколькими другими параметрами задач, влияющими на то, как задача обрабатывается планировщиком задач.

```xml
<?xml version="1.0" ?>

<!-- This sample schedules a task to start notepad.exe at a specific time. -->

<Task xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">

    <RegistrationInfo>
        <Date>2005-10-11T13:21:17-08:00</Date>
        <Author>AuthorName</Author>
        <Version>1.0.0</Version>
        <Description>Task starts after at a specified time.</Description>
    </RegistrationInfo>

    <Triggers>
        <TimeTrigger>
            <StartBoundary>2005-10-11T13:21:17-08:00</StartBoundary>
            <EndBoundary>2006-01-01T00:00:00-08:00</EndBoundary>
            <Enabled>true</Enabled>
            <ExecutionTimeLimit>PT5M</ExecutionTimeLimit>
        </TimeTrigger>
    </Triggers>

    <Principals>
        <Principal>
            <UserId>Administrator</UserId>
            <LogonType>InteractiveToken</LogonType>
        </Principal>
    </Principals>

    <Settings>
        <Enabled>true</Enabled>
        <AllowStartOnDemand>true</AllowStartOnDemand>
        <AllowHardTerminate>true</AllowHardTerminate>
    </Settings>

    <Actions>
        <Exec>
            <Command>notepad.exe</Command>
        </Exec>
    </Actions>

</Task>
```

Ниже приведены некоторые важные элементы, которые следует учитывать при использовании этого примера:

- **[RegistrationInfo](https://learn.microsoft.com/en-us/windows/win32/taskschd/taskschedulerschema-registrationinfo-tasktype-element)**: содержит сведения о регистрации задачи
  
- **[Triggers](https://learn.microsoft.com/en-us/windows/win32/taskschd/taskschedulerschema-triggers-tasktype-element)**: определяет триггер, запускающий задачу

- **[TimeTrigger](https://learn.microsoft.com/en-us/windows/win32/taskschd/taskschedulerschema-timetrigger-triggergroup-element)**: определяет триггер времени. В этом случае используются три дочерних элемента: границы начала и окончания, определяющие, когда триггер активируется и деактивирован, а также ограничение времени выполнения, указывающее максимальное время, в течение которого задача может быть запущена триггером. Элемент [StartBoundary](https://learn.microsoft.com/en-us/windows/win32/taskschd/taskschedulerschema-startboundary-triggerbasetype-element) является обязательным элементом для триггеров времени.

- **[Principal](https://learn.microsoft.com/en-us/windows/win32/taskschd/taskschedulerschema-principal-principaltype-element)**. Определяет контекст безопасности, в котором выполняется задача

- **[Settings](https://learn.microsoft.com/en-us/windows/win32/taskschd/taskschedulerschema-settings-tasktype-element)**. Определяет параметры задачи, которые планировщик задач использует для выполнения задачи

- **[Actions](https://learn.microsoft.com/en-us/windows/win32/taskschd/taskschedulerschema-actions-tasktype-element)**. Определяет действия, выполняемые задачей (в этом случае выполняется Блокнот)

Планировщик задач требует следующих операционных систем:

- Планировщик задач 2.0. Для клиента требуется Windows Vista или более поздней версии. Для сервера требуется Windows Server 2008 или более поздней версии.

- Планировщик задач 1.0. Для клиента требуется Windows Vista или Windows XP. Для сервера требуется Windows Server 2008 или Windows Server 2003.

## Сценарии использования регламентированных задач

| Сценарии планировщика задач 2.0 | Пояснения |
| -------- | --------- |
| Запуск исполняемого файла в определенное время | Важно отметить, что триггер по конкретному времени отличается от других триггеров по времени тем, что он активируется в начальной границе по времени. Другие триггеры по времени также активируются в начальной границе, но **не выполняют никаких действий, пока указанная дата запуска задачи не будет достигнута**. |
| Запуск исполняемого файла ежедневно | Ежедневные триггеры используют свою начальную границу для активации триггера и указания времени выполнения задачи. После активации триггера интервал триггеров используется для указания, выполняется ли задача ежедневно, каждый день, каждый третий день или т. д. |
| Запуск исполняемого файла при запуске ОС | Поддерживается задержка активации триггера после запуска ОС |
| Запуск исполняемого файла еженедельно |  |
| Запуск исполняемого файла при регистрации задачи | Задача выполняется немедленно, после своего создания. Поддерживается задержка по времени |
| Запуск исполняемого файла при входе пользователя в систему | Позволяет настраивать для конкретных пользователей |
| Список задач и отображение информации по задачам | Получить инфу о задачах можно либо через встроенные возможности Visual Basic (`Set service = CreateObject("Schedule.Service")`), либо через COM-интерфейс |

| Сценарии планировщика задач 1.0 | Пояснения |
| -------- | --------- |
| [Создание задачи через NewWorkItem](https://learn.microsoft.com/en-us/windows/win32/taskschd/creating-a-task-using-newworkitem-example) | Creates a new task. |
| [Enumerating Tasks Example](https://learn.microsoft.com/en-us/windows/win32/taskschd/enumerating-tasks-example) | Enumerates all the tasks on the local computer. |
| [Starting a Task Example](https://learn.microsoft.com/en-us/windows/win32/taskschd/starting-a-task-example) | Starts a known task. |
| [Editing a Work Item using Property Pages](https://learn.microsoft.com/en-us/windows/win32/taskschd/editing-a-work-item-using-property-pages) | Displays the property pages of a task for editing. |
| [Retrieving Work Item Property Examples](https://learn.microsoft.com/en-us/windows/win32/taskschd/retrieving-work-item-property-examples) | A set of examples that show how to retrieve properties that apply to all types of work items. |
| [Setting Work Item Property Examples](https://learn.microsoft.com/en-us/windows/win32/taskschd/setting-work-item-property-examples) | A set of examples that show how to set properties that apply to all types of work items. |
| [Retrieving Task Property Examples](https://learn.microsoft.com/en-us/windows/win32/taskschd/retrieving-task-property-examples) | A set of examples that show how to retrieve properties unique to tasks. |
| [Setting Task Property Examples](https://learn.microsoft.com/en-us/windows/win32/taskschd/setting-task-property-examples) | A set of examples that show how to set properties unique to tasks. |
| [Retrieving a Task Page Example](https://learn.microsoft.com/en-us/windows/win32/taskschd/retrieving-a-task-page-example) | Retrieves and displays the general task page of a known task. |
| [Creating a New Trigger](https://learn.microsoft.com/en-us/windows/win32/taskschd/creating-a-new-trigger) | Creates a new trigger for a known task. |
| [Creating an Idle Trigger Example](https://learn.microsoft.com/en-us/windows/win32/taskschd/creating-an-idle-trigger-example) | Creates an event-based idle trigger for a known task. |
| [Terminating a Task Example](https://learn.microsoft.com/en-us/windows/win32/taskschd/terminating-a-task-example) | Terminates a task while it is running. |
| [Retrieving Trigger Strings Example](https://learn.microsoft.com/en-us/windows/win32/taskschd/retrieving-trigger-strings-example) | Retrieves the trigger string of all triggers associated with a known task. |

#Administration
