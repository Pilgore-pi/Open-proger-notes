## Описание функционала

Приложение со списком шуточных вопросов

Поддерживаемые операции: CRUD

- Create (Создание)
- Read (Чтение)
- Update (Редактирование)
- Delete (Удаление)

Шутки и ответы будут храниться в базе данных MS SQL Server

## Алгоритм действий

### 01 Создание проекта по шаблону

**В Visual Studio:**
- `ASP.NET Core Web Application`
- Выберите последнюю версию .NET
- Выберите шаблон проекта ASP.NET: `Web Application (Model-View-Controller)`
- Аутентификация: `Individual user accounts`

**В JetBrains Rider:**
- `Web > Web App (Model-View-Controller)`
- Выберите последнюю версию .NET
- Аутентификация: `Auth > Individual authentication`

MVC версия проекта является Full-stack решением, поэтому никакие фронтенд фреймворки использоваться не будут

- По умолчанию в проекте уже создана база данных SQL

### 02 Запуск проекта

Запустим проект. При запуске должна открыться главная страница приложения в браузере по умолчанию.

По умолчанию, на странице уже есть сслыки на 2 страницы:

- `Home`
- `Privacy`

А также элементы управления перехода к странице регистрации или входа

### 03 Редактирование представлений

Изменим контент стартовой страницы, изменив текст на ней. Откроем файл в проекте "`Views/Home/Index.cshtml`". Он будет содержать примерно такое содержимое:

```razor
@{  
    ViewData["Title"] = "Home Page";  
}  
  
<div class="text-center">  
    <h1 class="display-4">Welcome</h1>  
    <p>Learn about <a href="https://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>  
</div>
```

Заменим английский текст на русский:

```razor
@{  
    ViewData["Title"] = "Домашняя страница";  
}  
  
<div class="text-center">  
    <h1 class="display-4">Добро пожаловать</h1>  
    <p>Узнайте больше о <a href="https://learn.microsoft.com/aspnet/core">разработке веб-приложений с помощью ASP.NET Core</a>.</p>  
</div>
```

`ViewData["Title"]` — это свойство, которое хранит текст заголовка страницы (аналог HTML `<title>`) 

### Пояснение паттерна проектирования MVC

Представления, согласно паттерну MVC — это интерфейс приложения, с которым работает пользователь, в данном случае это **Razor HTML + CSS**

Модели — это структуры данных и модули (классы и объекты), содержащие сервисную логику (например инициализация БД, описание интерфейса взаимодействия с удаленным веб-севрисом и т.д.)

Контроллеры — это модули, которые содержат основную логику приложения и логику связывания компонентов приложения. Контроллеры обращаются к API моделей, используют их в своих алгоритмах и передают в представления. С другой стороны, пользователь вводит даные в представлениях, которые обрабатываются контроллерами и помещаются в модели

**Зачем используется паттерн MVC?**

- Для разделения логики и соблюдения модульности
- Для обеспечения масштабируемости
- Для разработки несколькими программистами, в том числе одновременно

### 04 Создание модели шуток

В каталоге **Models** создадим новую модель (класс C#), который будет представлять шутку. Шутка имеет следующую структуру:

- ID
- Вопрос шутки (у нас все шутки будут в форме вопроса)
- Ответ

Назовем модель `Joke`:

```csharp
namespace JokesExampleWebApp.Models;  
  
public class Joke {  
      
    public int Id { get; set; }  
    public string Question { get; set; }  
    public string Answer { get; set; }  
}
```

### 05 Создание контроллера

Для нашей модели создадим контроллер. Согласно модели MVC, одному контроллеру соответствует одна модель

**В IDE Rider:**

- ПКМ на каталог `Controllers > Add > Scaffolded item...`
- `MVC Controller with views, using Entity Framework`
- Назовите контроллер `JokesController`
- Выберите модель для контроллера`Model class -> Jokes`
- Задайте контекст базы данных (выберите класс `ApplicationDbContext.cs`)
- `Generate views` (сгенерировать представления) -> да
- `Reference script libraries` (создать ссылки на библиотеки) -> да
- `Use a layout page` (использовать макет страницы) -> да
- Нажать `Add`

**В IDE Visual Studio:**

- ПКМ на каталог `Controllers > Add > Controller...` (`Контроллеры > Добавить > Контроллер...`)
- `MVC Controller with views, using Entity Framework`
- Выберите модель для контроллера`Model class -> Jokes`
- Задайте контекст базы данных (выберите класс `ApplicationDbContext.cs`)
- Generate views (сгенерировать представления) -> да
- Reference script libraries (создать ссылки на библиотеки) -> да
- Use a layout page (использовать макет страницы) -> да
- Нажать `Add`
  
После выполнения этих действий, будет начат процесс подгрузки нужных зависимостей

Будут сгенерированы представления с 4 операциями (`Views/Jokes`):

- `Create.cshtml` — создание
- `Delete.cshtml` — удаление
- `Details.cshtml` — подробности
- `Edit.cshtml` — редактирование
- `Index.cshtml` — основное представление для `Joke`

### 06 Запуск новосозданного представления

Теперь нам доступна новая страница `Jokes`. Запустим приложение. В строке поиска браузера указан текущий URL примерно такого содержания: `http://localhost:5299/`

Чтобы попасть на новую страницу, нужно к URL добавить ее название, которое совпадает с названием каталога `Views/Jokes`.

```url
http://localhost:5299/Jokes
```

Так как мы еще не настроили БД, мы получаем ошибку:

![](aspnetHTMLexample.html)

### 07 Настройка базы данных

Чтобы начать пользоваться базой данных SQL, необходимо добавить новую миграцию.

**В Visual Studio:**

Откроем Консоль Менеджера Пакетов (Package Manager Console) и выполним команду:

```
add-migration "initialset"
```

**В JetBrains Rider:**

> Требуется установленный инструмент `dotnet ef`

```
ПКМ по проекту -> Entity Framework Core -> Add migration...
```

1. Имя миграции — это имя генерируемого класса-наследника от `Migration`, поэтому, желательно, следует присваивать имя в соответствии со стандартами именования .NET.
2. В качестве контекстного класса нашей БД, нужно выбрать `ApplicationDbContext`
3. В качестве каталога, где будет создаваться миграция, выберем Data\Migrations
4. Нажимаем ОК

Можно посмотреть, какую команду Rider сгенерировал при выборе настроек миграции (Кнопка `Preview`), к примеру:

Путь к рабочей директории:

```
C:\WebApplication1
```

Команда:

```
C:\Users\andre\.dotnet\dotnet.exe ef migrations add --project JokesExampleWebApp\JokesExampleWebApp.csproj --startup-project JokesExampleWebApp\JokesExampleWebApp.csproj --context Microsoft.AspNetCore.Identity.EntityFrameworkCore.IdentityDbContext`3 --configuration Debug Initial --output-dir Data\Migrations
```

При выполнении команды через конструктор миграций, может возникнуть ошибка "`Build failed. Use dotnet build to see the errors.`". В таком случае можно попробовать выполнить команду напрямую, открыв терминал в Rider или, непосредственно, терминал ОС

#### Что означает термин Миграция?

Миграция, в контексте ORM, — это операция по обновлению базы данных. Миграции подразумевают изменение структуры SQL таблиц

#### 07.1 Применение изменений

Мы создали миграцию (обновление) базы данных, теперь ее нужно применить с помощью команды `update database`

`ПКМ по проекту -> Entity Framework Core -> Update Database... -> OK`

Если опять возникает ошибка `Build failed. Use dotnet build to see the errors.`, можно попробовать выполнить сгенерирванную команду в терминале (возможно потребуется перезапустить IDE)

После выполнения команды, нужно открыть окно `Database` (Rider) или `SQL Server Object Explorer` (Visual Studio)

В окне обозревателя БД можно обнаружить множество сгенерированных служебных таблиц и одну таблицу `Joke`, которая была создана на основе нашей модели `class Joke`.

В разных версиях IDE конкретные действия могут отличаться, но в целом алгоритм действий общий. В Rider можно открыть Быструю документацию (`Quick documentation`) или перейти к DDL определению таблицы:

```sql
-- auto-generated definition
create table Joke
(
    Id       INTEGER not null
        constraint PK_Joke primary key autoincrement,
    Question TEXT    not null,
    Answer   TEXT    not null
);
```

Это код SQL Lite, так как эта СУБД по умолчанию используется в Rider

### 08 Запустим проект

При обновлении БД, автоматически была сгенерирована страница `localhost:5299/Jokes`, но в данный момент, на наших страницах нет ни одной ссылки на эту страницу, поэтому вручную введем адрес этой страницы в строке поиска

Откроется страница, где можно редактировать и добавлять записи таблицы `Joke`. На странице указаны все свойства объекта `Joke` и доступны CRUD операции (`Create new`, `Edit`, `Details`, `Delete`)

В целом, минимально работоспособная версия приложения уже готова. Дальнейшие действия зависят от требований заказчика

### 09 Добавление ссылки на новую страницу

По умолчанию, ссылка на страницу с таблицей `Joke` отсутствует на сайте. Поэтому мы создадим ее сами.

В дереве проектов, в каталоге `View > Shared` есть файл `_Layout.cshtml`, который определяет расположение элементов на главной страницы.

Найдем элемент DOM-дерева:

```html
<header ...>
  <nav ...>
    <div ...>
      <div ...>
        <ul class="navbar-nav flex-grow-1">
          <li class="nav-item">
            <a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Index">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
          </li>
          ...
```

Здесь

- `asp-controller` — это имя контроллера данного представления (без приписки `Controller` в конце)
- `asp-action` — метод со специальной сигнатурой, который выполняется при нажатии на ссылку (тег `<a>`)

В теге `<ul>` добавим еще один элемент `<li>`, который будет содержать ссылку на страницу с шутками:

```html
<li class="nav-item">
    <a
        class="nav-link text-dark"
        asp-area=""
        asp-controller="Jokes"
        asp-action="Index">
            Jokes
    </a>
</li>
```

> `Index` — это стандартная страница по умолчанию

#Web #Dotnet/ASP-NET #Практика
