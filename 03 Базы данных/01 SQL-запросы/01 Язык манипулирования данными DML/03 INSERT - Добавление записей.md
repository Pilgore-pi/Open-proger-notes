# ЗАМЕНИТЬ НА СИНТАКСИС POSTGRESQL

Назад: [SELECT - Выборка данных](02%20SELECT%20-%20Выборка%20данных.md)
Далее: [WHERE - Фильтрация](04%20WHERE%20-%20Фильтрация.md)

Добавление данных в таблицу осуществляется командой `INSERT`

[Документация по PostgreSQL](https://postgrespro.ru/docs/postgresql/current/sql-insert)

Синтаксис:

```sql
INSERT [INTO] table_name [(<attributes>)]
VALUES (<new_values>)[, (<new_values>)]
```

* `<attributes>` — должны быть перечислены все поля таблицы через запятую, у которых нет значения по умолчанию.
* `VALUES` — можно добавлять неограниченное количество записей

`INSERT` добавляет строки в таблицу. Эта команда может добавить одну или несколько строк, сформированных выражениями значений, либо ноль или более строк, выданных дополнительным запросом.

Имена целевых столбцов могут перечисляться в любом порядке. Если список с именами столбцов отсутствует, по умолчанию целевыми столбцами становятся все столбцы заданной таблицы; либо первые `N` из них, если только `N` столбцов поступает от предложения `VALUES` или запроса. Значения, получаемые от предложения `VALUES` или запроса, связываются с явно или неявно определённым списком столбцов слева направо.

Все столбцы, не представленные в явном или неявном списке столбцов, получат значения по умолчанию, если для них заданы эти значения, либо `NULL` в противном случае.

Если выражение для любого столбца выдаёт другой тип данных, система попытается автоматически привести его к нужному.

Пример:

Пусть имеется таблица:

```sql
CREATE TABLE Product
(
    ID INT IDENTITY PRIMARY KEY,
    ProductName NVARCHAR(30) NOT NULL,
    Manufacturer NVARCHAR(20) NOT NULL,
    ProductCount INT DEFAULT 0,
    Price MONEY NOT NULL
)
```

Добавление одной записи:

```sql
INSERT Product VALUES ('iPhone 7', 'Apple', 5, 52000)
```

Значения после `VALUES` добавляются по порядку

Если опустить список атрибутов для добавления значений, то по умолчанию будут выбраны все атрибуты, кроме атрибутов с автоинкрементом, а порядок будет определяться порядком добавления атрибутов при создании таблицы.

Можно добавлять значения в другом порядке при указанном кортеже атрибутов:

```sql
INSERT INTO Product (ProductName, Price, Manufacturer) 
VALUES ('iPhone 6S', 41000, 'Apple')
```

- Для неуказанных столбцов будет добавляться значение по умолчанию, если задан атрибут `DEFAULT`, или значение `NULL`. При этом неуказанные столбцы должны допускать значение `NULL` или иметь атрибут `DEFAULT`.

Если все столбцы имеют атрибут `DEFAULT`, определяющий значение по умолчанию, или допускают значение `NULL`, то можно для всех столбцов вставить значения по умолчанию:

```sql
INSERT INTO Product DEFAULT VALUES
```

## Вставка значений из запроса

Синтаксис корректен для СУБД: MS SQL Server, SQLite, MySQL, Oracle

```sql
insert into Payments (payment_id, family_member, good, amount, unit_price, date)
select
    payment_id + 100,
    family_member,
    good,
    amount*64,
    unit_price,
    now()
from Payments;

select * FROM Payments
```

- Операция INSERT с таблицами без уникальных индексов не блокируется параллельно выполняемыми операциями. В таблицах с уникальными индексами эта операция может блокироваться, если в параллельных сеансах выполняются действия, которые блокируют или изменяют строки, совпадающие с вставляемыми значениями в уникальном индексе; подробнее см. Раздел 63.5. Предложение `ON CONFLICT` позволяет задать действие, заменяющее возникновение ошибки при нарушении ограничения уникальности или ограничения-исключения. (См. описание Предложение `ON CONFLICT` ниже.)

С необязательным предложением `RETURNING` команда `INSERT` вычислит и вернёт значения для каждой фактически добавленной строки (или изменённой, если применялось предложение ON CONFLICT DO UPDATE). В основном это полезно для получения значений, присвоенных по умолчанию, например, последовательного номера записи. Однако в этом предложении можно задать любое выражение со столбцами таблицы. Список RETURNING имеет тот же синтаксис, что и список результатов `SELECT`. В результате будут возвращены те строки, которые были успешно вставлены или изменены. Например, если строка была заблокирована, но не изменена, из-за того, что условие в предложении `ON CONFLICT DO UPDATE ... WHERE` не удовлетворено, эта строка возвращена не будет.

Чтобы добавлять строки в таблицу, необходимо иметь право `INSERT` для неё. Если присутствует предложение `ON CONFLICT DO UPDATE`, также требуется иметь право `UPDATE` для этой таблицы.

Если указывается список столбцов, достаточно иметь право INSERT только для перечисленных столбцов. Аналогично, с предложением `ON CONFLICT DO UPDATE` достаточно иметь право `UPDATE` только для столбцов, которые будут изменены. Однако предложение `ON CONFLICT DO UPDATE` также требует наличия права `SELECT` для всех столбцов, значения которых считываются в выражениях `ON CONFLICT DO UPDATE` или в условии

Для применения предложения `RETURNING` требуется право `SELECT` для всех столбцов, перечисленных в `RETURNING`. Если для добавления строк применяется запрос, для всех таблиц или столбцов, задействованных в этом запросе, разумеется, необходимо иметь право `SELECT`

## Предложение `ON CONFLICT`

Необязательное предложение ON CONFLICT задаёт действие, заменяющее возникновение ошибки при нарушении ограничения уникальности или ограничения-исключения. Для каждой отдельной строки, предложенной для добавления, добавление либо выполняется успешно, либо, если нарушается решающее ограничение или индекс, задаваемые как объект_конфликта, выполняется альтернативное действие_конфликта. Вариант ON CONFLICT DO NOTHING в качестве альтернативного действия просто отменяет добавление строки. Вариант ON CONFLICT DO UPDATE изменяет существующую строку, вызвавшую конфликт со строкой, предложенной для добавления.

Задаваемый объект_конфликта может выбирать уникальный индекс. Определение объекта, позволяющее выбрать индекс, включает один или несколько столбцов (их определяет имя_столбца_индекса) и/или выражение_индекса и необязательный предикат_индекса. Все уникальные индексы в таблице имя_таблицы, которые, без учёта порядка столбцов, содержат в точности столбцы/выражения, определяющие объект_конфликта, выбираются как решающие индексы. Если указывается предикат_индекса, он должен, в качестве дополнительного требования выбора, удовлетворять индексам. Заметьте, что это означает, что не частичный уникальный индекс (уникальный индекс без предиката) будет выбран (и будет использоваться в ON CONFLICT), если такой индекс удовлетворяет всем остальным критериям. Если попытка выбрать индекс оказывается неудачной, выдаётся ошибка.

ON CONFLICT DO UPDATE гарантирует атомарный результат команды INSERT или UPDATE; при отсутствии внешних ошибок гарантируется один из двух этих исходов, даже при большой параллельной активности. Эта операция также известна как UPSERT — «UPDATE или INSERT».

Далее: [WHERE - Фильтрация](04%20WHERE%20-%20Фильтрация.md)

#DB #SQL #SQL/DML
